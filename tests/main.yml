---
- name: test rabbitmq-vhost role
  hosts: localhost
  become: true
  roles:
    - role: CyVerse-Ansible.rabbitmq-vhost
      rabbitmq_vhost_name: /vhost
      rabbitmq_vhost_users: 
        - name: admin
          configure_priv: .*
          read_priv: .*
          write_priv: .*
          tags:
            - administrator

- name: verify configuration
  tags:
    - test
  hosts: localhost
  become: true
  gather_facts: false
  tasks:
    - set_fact:
        any_failed: false

    - include: test.yml
      vars:
        test: "{{ item }}"
      with_items:
        - name: Verify that vhost /vhost created
          cmd: rabbitmqctl list_vhosts | grep --quiet --regexp '^/vhost$'

        - name: Verify user admin created
          cmd: rabbitmqctl list_users | grep --quiet --regexp '^admin[[:space:]]*\[administrator\]$'

        - name: Verify user admin has correct permissions
          cmd: |
            rabbitmqctl list_permissions -p /vhost \
              | grep --quiet --regexp '^admin[[:space:]]*\.\*[[:space:]]*\.\*[[:space:]]*\.\*$'

    - when: any_failed
      fail:
        msg: some of the tests failed
